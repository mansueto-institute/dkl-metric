---
title: "data_exploration"
author: "Ivanna Rodr√≠guez"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width = 12)
```

```{r}
pacman::p_load(tidyverse, arrow, sf, tidycensus, viridis, patchwork)
source("plotting.R")

df15_dkl <- read_parquet("data/df15_dkl.parquet")
df20_dkl <- read_parquet("data/df20_dkl.parquet")
```

```{r, include=FALSE}
# get geographic data for maps
geom_tract_20 <- get_acs(year = 2020, geography = "tract", survey = 'acs5', variables = 'B02001_001', state = '17', county = '031', geometry = TRUE) %>%
  select(GEOID) %>% st_transform(crs = st_crs(4326)) 

geom_tract_15 <- get_acs(year = 2015, geography = "tract", survey = 'acs5', variables = 'B02001_001', state = '17', county = '031', geometry = TRUE) %>%
  select(GEOID) %>% st_transform(crs = st_crs(4326)) 

community_areas <- sf::st_read('https://data.cityofchicago.org/api/geospatial/cauq-8yn6?method=export&format=GeoJSON') %>% 
  st_transform(crs = st_crs(4326)) %>% 
  st_as_sf() %>% 
  select(community)

geom_tract_20 <- geom_tract_20 %>%
  st_join(., community_areas, left= TRUE, largest = TRUE) %>%
  filter(!is.na(community))

geom_tract_15 <- geom_tract_15 %>%
  st_join(., community_areas, left= TRUE, largest = TRUE) %>%
  filter(!is.na(community))
```

```{r}
# income buckets do these need to be adjusted for inflation? or does it not matter bc we're using DKL metric?

all_dkl <- bind_rows(
  mutate(df15_dkl, year = 2015),
  mutate(df20_dkl, year = 2020)
)

plot_bin_bar_facets(all_dkl, group_lab = 'Household income', cbsa = '16980')
plot_bin_bar_facets(all_dkl, group_lab = 'Race', cbsa = '16980')
plot_bin_bar_facets(all_dkl, group_lab = 'Industry', cbsa = '16980')
plot_bin_bar_facets(all_dkl, group_lab = 'Occupation', cbsa = '16980')
plot_bin_bar_facets(all_dkl, group_lab = 'Education attainment', cbsa = '16980')
plot_bin_bar_facets(all_dkl, group_lab = 'Age', cbsa = '16980')
plot_bin_bar_facets(all_dkl, group_lab = 'Employment status', cbsa = '16980')
```
```{r}
plot_bin_bar_dodge(all_dkl, group_lab = 'Household income', cbsa = '16980')
plot_bin_bar_dodge(all_dkl, group_lab = 'Race', cbsa = '16980')
plot_bin_bar_dodge(all_dkl, group_lab = 'Industry', cbsa = '16980')
plot_bin_bar_dodge(all_dkl, group_lab = 'Occupation', cbsa = '16980')
plot_bin_bar_dodge(all_dkl, group_lab = 'Education attainment', cbsa = '16980')
plot_bin_bar_dodge(all_dkl, group_lab = 'Age', cbsa = '16980')
plot_bin_bar_dodge(all_dkl, group_lab = 'Employment status', cbsa = '16980')
```

```{r}
# race maps
p_rac_15 <- geom_tract_15 %>% 
  left_join(df15_dkl, by = c('GEOID'='tract_fips')) %>% 
  filter(group_label == 'Race') %>%
  select(GEOID, group_label, dkl_tract) %>%
  distinct() %>%
  ggplot(aes(fill = dkl_tract , color = dkl_tract)) +
  geom_sf() + 
  scale_fill_viridis() + 
  scale_color_viridis() +
  labs(title = 'DKL for Race, 2015') +
  theme_minimal() + 
  theme(legend.title = element_blank(), 
        axis.text = element_blank())

p_rac_20 <- geom_tract_20 %>% 
  left_join(df20_dkl, by = c('GEOID'='tract_fips')) %>% 
  filter(group_label == 'Race') %>%
  select(GEOID, group_label, dkl_tract) %>%
  distinct() %>%
  ggplot(aes(fill = dkl_tract , color =  dkl_tract)) +
  geom_sf() + 
  scale_fill_viridis() + 
  scale_color_viridis() +
  labs(title = 'DKL for Race, 2020') +
  theme_minimal() + 
  theme(legend.title = element_blank(), 
        axis.text = element_blank())

p_rac_15 + p_rac_20
```



